[目次](Index.md)

---

# 使い方

ここでは、「認証プロキシ爆発しろ！」の利用法について説明します。

* [コマンドライン](#コマンドライン)
* [一般的な利用方法](#一般的な利用方法)
* [PC上の内部ネットワークに対するプロキシとしても動作させる場合](#PC上の内部ネットワークに対するプロキシとしても動作させる場合)
* [PC上の内部ネットワークに対するプロキシとしてのみ動作させる場合](#PC上の内部ネットワークに対するプロキシとしてのみ動作させる場合)


## コマンドライン

「認証プロキシ爆発しろ！」のコマンドラインは以下の通りです。

```
(コマンドファイル名) [Options]
```

コマンドファイル名は以下になります。

| 種類 | ファイル名 |
|:----|:----|
| Windows コマンド | mape.exe |
| Windows GUI | mapegui.exe |

オプションの詳細については、
[コマンドラインオプションリファレンス](Reference_Options.md)を参照してください。


## 一般的な利用方法

PC上で実行するソフトウェアの通信を中継する場合。

![一般的なケースのネットワーク図](images/Usage_Pattern1.png)

単純に実行します。
中継を行っている間、
「認証プロキシ爆発しろ！」はシステムのプロキシ設定を自分（既定では127.0.0.1:8888）に書き換えます。
中継を停止すると、元の設定に書き戻します。

この場合のコマンドラインは以下になります。

```
mape.exe
```

上のコマンドラインはコマンド版の場合です。GUI版を実行する場合は`mape.exe`を`mapegui.exe`に置き換えてください。
以下の例でも同様です。

アプリが認証プロキシに対応していなくても、
「認証プロキシ爆発しろ！」が認証を行いますので、
アプリは外部と通信できます。


## PC上の内部ネットワークに対するプロキシとしても動作させる場合

PC内でVMを繋ぐネットワークを運用する場合があります。
Hyper-VでVMを内部仮想スイッチに接続する場合などがこれに相当します。
例えば、Docker for Windowsを利用する場合、
Linux版のDockerを動かすVMは"DockerNAT"という名前の内部仮想スイッチに接続されます。

この内部ネットワークのPC側アドレス上で待ち受けを行うことで、
内部ネットワークに対するプロキシとしても動作させることができます。
このとき、VM上のアプリが認証プロキシに対応していないくても、
「認証プロキシ爆発しろ！」が認証を行いますので、
アプリは外部と通信できます。

![内部ネットワークに対しても中継を行うケースのネットワーク図](images/Usage_Pattern2.png)

この場合、追加の待受アドレスを`AdditionalListeners`オプションで指定します。
上の図の例の場合、コマンドラインで以下のように指定します。

```
mape.exe /AdditionalListeners:"[{\"Address\": \"192.168.137.1\", \"Port\": 8888}]"
```

`AdditionalListeners`オプションの値はJson形式です。
値の中に引用符を記述する必要があるため、
値全体を引用符で括り、さらにその中の引用符をエスケープしていることに注意してください。

なお、PC内ネットワークのアドレスのみを待受けアドレスとするようにしてください。
外部に公開されているアドレスを待受けアドレスにすると、
外部から「認証プロキシ爆発しろ！」を通して認証プロキシを通ることができるようになってしまいます。

なお、このケースの場合、
「認証プロキシ爆発しろ！」中継中はPCのプロキシ設定を書き換えますが、
VMの設定は書き換えません。


## PC上の内部ネットワークに対するプロキシとしてのみ動作させる場合

上の例と似ていますが、
PC内のアプリは既定の認証プロキシを直接使い、
「認証プロキシ爆発しろ！」を内部ネットワークに対するプロキシとしてのみ利用する場合です。

![内部ネットワークに対してのみ中継を行うケースのネットワーク図](images/Usage_Pattern3.png)

この場合、メインの待受けアドレスを内部ネットワークのPC側アドレスに設定します。
メインの待受けアドレスの規定値ではなくなるため、
アドレスを明に指定する必要があります。
また、PCのプロキシ設定の書換えが不要ですので、設定書換えも抑止します。

```
mape.exe /MainListener:"{\"Address\": \"192.168.137.1\", \"Port\": 8888}" /EnableSystemSettingsSwitch:false
```

`AdditionalListeners`ではなく、`MainListener`オプションを使います。
`MainListener`は`AdditionalListeners`と同じくJson形式で値を指定しますが、
`AdditionalListeners`はJsonの配列であるのに対し、
`MainListener`は単一のオブジェクトであることに注意してください。
