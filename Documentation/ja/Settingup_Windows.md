[目次](Index.md)

---

# セットアップ（Windows版）

ここではWindows版のセットアップ方法について説明します。

* [システム要件](#システム要件)
* [プログラムの取得](#プログラムの取得)
* [初期設定](#初期設定)
* [テスト](#テスト)
* [実行](#実行)


## システム要件

想定している動作環境は以下の通りです。

| 対象 | 条件 |
|:-----|:-----|
| OS | Windows （下記.NET Frameworkが動作するバージョン）|
| .NET Framework | 4.5以降 |

作者が実際に動かしてみている環境は、
Windows 10 (x64) version 1607, .NET Framework 4.6.2です。


## プログラムの取得

ソースをビルドするか、
[リリース](../../Releases/README.ja.md)からバイナリを取得して、
適切な場所に解凍して利用してください。


## 初期設定

「認証プロキシ爆発しろ！」はほとんどの設定を自動的に認識しますが、
以下の条件に該当する場合、
初期設定が必要な項目があります。

コントロールパネルの「インターネット オプション」-「接続」-「LANの設定」において、
* 「設定を自動的に検出する」が有効な場合。または、
* 「自動構成スクリプトを使用する」が有効な場合。または、
* 「詳細設定」の「次で始まるアドレスにはプロキシを使用しない」が空白の場合。

この条件が当てはまらない場合は、特に設定は不要です。
[テスト](#テスト)へ進んでください。

### 問題となる設定

「認証プロキシ爆発しろ！」は通信を中継する際にプロキシ設定を書き換えます。
ほとんどの設定項目は自動的に適切な値に書き換えられますが、
以下の設定項目に関してはどのように書き換えればよいか自動的に判断できないため、
これらの値をあらかじめ教えておく必要があります。

* コントロールパネルの「インターネット オプション」-「接続」-「LANの設定」における、
    * 「ローカルアドレスにはプロキシサーバーを使用しない」
    * 「詳細設定」-「次で始まるアドレスにはプロキシを使用しない」

なお、「次で始まるアドレスにはプロキシを使用しない」が空白でない場合（すでに設定されている場合）、
「認証プロキシ爆発しろ！」はその値を流用しますので、
この後の設定作業は不要です。

### 設定内容の決定

プロキシを使用しないアドレスを列挙し、セミコロンで繋ぎます。
これは、コントロールパネルの「インターネット オプション」の「次で始まるアドレスにはプロキシを使用しない」設定の書式と同じです。
また、「ローカルアドレスにはプロキシサーバーを使用しない」に該当する場合は、
そのアドレスリストに`<local>`を含めます。

プロキシを使用しないアドレスが分からない場合は、ネットワーク管理者に聞いてください。
なのですが、
一般に認証プロキシが導入されているような環境の場合、
社内ネットワークのドメイン名がそれに該当する場合が多いでしょう。

以下はある環境における設定内容の例です。

```
*.example.com;*.example.local;<local>
```

### 設定

コンソール（コマンドプロンプトまたはPowerShell）を開き、
「認証プロキシ爆発しろ！」のフォルダに移動し、
以下のコマンドを実行します。

```
.\mape.exe /Save /ProxyOverride:<上記のように決定した設定内容>
```

例えば、上の例の設定内容の場合、コマンドラインは以下になります。
&lt;と&gt;が特殊文字であるため、引用符で括る必要があることに注意してください。

```
.\mape.exe /Save /ProxyOverride:"*.example.com;*.example.local；<local>"
```


## テスト

中継機能が正しく動作しているか、
GUI版の「認証プロキシ爆発しろ！」でテストしてみます。

1. コンソール（コマンドプロンプトまたはPowerShell）を開き、
「認証プロキシ爆発しろ！」のフォルダに移動し、
以下のコマンドを実行します。

    ```
    .\mapegui.exe /EnableSystemSettingsSwitch:false
    ```

1. タスクトレイに「認証プロキシ爆発しろ！」のアイコンが現れます。
アイコンを右クリックし、
コンテキストメニューから「中継を開始する」を選択します。

    すると、「認証プロキシ爆発しろ！」は通信の中継を開始しますが、
    /EnableSystemSettingsSwitch:falseオプションが指定されているため、
    ユーザーのプロキシ設定を変更することなく中継機能だけが稼働します。
    つまり、この時点ではブラウザ等の通信には影響しません。

    この中継機能は、デフォルトでは 127.0.0.1:8888 で接続を待ちます。

1. PowerShellを開き、
以下のコマンドを実行してみます。
www.google.comは外部のアドレスであればどこでも構いませんが、
テキストの内容を返すアドレスがよいでしょう。

    ```
    Invoke-WebRequest -Uri "http://www.google.com/" -Proxy "http://127.0.0.1:8888/"
    ```

1. 認証情報の入力を求めるダイアログが表示されますので、
認証プロキシに対する認証情報を入力します。

1. Invoke-WebRequestコマンドが正しくデータ（Webページのデータ）を返せばOKです。

1. タスクトレイのアイコンを右クリックし、「認証プロキシ爆発しろ！を終了する」を選択すると、
「認証プロキシ爆発しろ！」が終了します。


## 実行

「認証プロキシ爆発しろ！」はGUI版とコマンド版があります。

### GUI版の場合

`mapegui.exe`を実行します。

タスクトレイにアイコンが表示されますので、
そのアイコンのコンテキストメニューから中継機能を開始・停止できます。
アプリケーションを終了させる場合は、
タスクトレイのコンテキストメニューから「認証プロキシ爆発しろ！の終了」を選択します。

コンテキストメニューからウィンドウを表示させることができますが、
その中身は現在実装されていません。

### コマンド版の場合

コンソール（コマンドプロンプトまたはPowerShell）を開き、
`mape.exe`を実行します。

```
.\mape.exe
```

コマンドが実行されると直ちに中継機能が開始されます。
コンソールにはログが表示されます。
コマンドを終了するには、Ctrl+Cを押します。
